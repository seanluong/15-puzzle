/*! 15-puzzle 29-09-2014 */
var Board=function(a){a?(this.cells=a.cells,this.row=a.row,this.col=a.col,this.target=a.target,this.locked=a.locked):(this.cells=[[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,0]],this.row=3,this.col=3,this.target=[[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,0]],this.locked=!1,this.shuffle())};Board.prototype.shuffle=function(a){for(var b,c=a||100;c>0;){switch(b=parseInt(4*Math.random())){case 0:this.slideLeft();break;case 1:this.slideRight();break;case 2:this.slideUp();break;case 3:this.slideDown()}c--}},Board.prototype.slideLeft=function(){var a;return 0!==this.col&&(a=this.cells[this.row][this.col],this.cells[this.row][this.col]=this.cells[this.row][this.col-1],this.cells[this.row][this.col-1]=a,this.col-=1),this},Board.prototype.slideRight=function(){var a;return 3!==this.col&&(a=this.cells[this.row][this.col],this.cells[this.row][this.col]=this.cells[this.row][this.col+1],this.cells[this.row][this.col+1]=a,this.col+=1),this},Board.prototype.slideUp=function(){var a;return 0!==this.row&&(a=this.cells[this.row][this.col],this.cells[this.row][this.col]=this.cells[this.row-1][this.col],this.cells[this.row-1][this.col]=a,this.row-=1),this},Board.prototype.slideDown=function(){var a;return 3!==this.row&&(a=this.cells[this.row][this.col],this.cells[this.row][this.col]=this.cells[this.row+1][this.col],this.cells[this.row+1][this.col]=a,this.row+=1),this},Board.prototype.won=function(){var a,b;for(a in this.cells)for(b in this.cells[a])if(this.cells[a][b]!==this.target[a][b])return!1;return!0};var GuideModalInstanceCtrl=function(a,b){a.ok=function(){b.dismiss("done")}},GameWonModalInstanceCtrl=function(a,b){a.ok=function(){b.close({})}},myController=function(a,b,c,d,e){function f(b,c){"up"==b?a.board.slideUp():"down"==b?a.board.slideDown():"left"==b?a.board.slideLeft():a.board.slideRight(),a.$emit("board-change",{duration:c})}a.board=new Board(JSON.parse(localStorage.getItem("board"))),a.timePassed=parseInt(localStorage.getItem("timePassed"))||0,a.bestTime=parseInt(localStorage.getItem("bestTime"))||"NA";var g=d(function(){a.timePassed+=1,localStorage.setItem("timePassed",a.timePassed)},1e3,0,!0);a.$on("$destroy",function(){d.cancel(g)});var h={38:"up",40:"down",37:"left",39:"right"};e.ready(function(){a.$emit("init")}),a.swipe=function(a){a.preventDefault(),f(a.gesture.direction,50)},a.handleKeyDown=function(b){var c=b.altKey||b.ctrlKey||b.metaKey||b.shiftKey;if(!c&&(console.log(a.board.locked),!a.board.locked))switch(b.which){case 38:case 40:case 37:case 39:b.preventDefault(),f(h[b.which],10)}},a.$on("board-change",function(b,c){b.stopPropagation(),a.board.won()===!0?a.$emit("game-won",{}):(localStorage.setItem("board",JSON.stringify(a.board)),a.$emit("move",c))}),a.$on("game-won",function(b){b.stopPropagation(),a.handleGameWon()}),a.getCellHTML=function(b,c){var d=a.board.cells[b][c];return 0!==d?d:""},a.newGame=function(){a.timePassed=0,c(function(){a.bestTime=parseInt(localStorage.getItem("bestTime"))},0,!0),a.board=new Board,localStorage.setItem("board",JSON.stringify(a.board)),a.$emit("init"),a.resume()},a.pause=function(){a.board.locked=!0},a.resume=function(){a.board.locked=!1},a.guide=function(){var c=b.open({templateUrl:"template/guide.html",controller:GuideModalInstanceCtrl});a.pause(),c.result.then(function(){},function(){a.resume()})},a.handleGameWon=function(c){var d=b.open({templateUrl:"template/won.html",scope:a,controller:GameWonModalInstanceCtrl,size:c});a.pause();var e=localStorage.getItem("bestTime");(!e||a.timePassed<parseInt(e))&&localStorage.setItem("bestTime",a.timePassed),d.result.then(function(){a.newGame()},function(){a.newGame()})}},durationFilter=function(){function a(a){return a>9?a:a>=0?"0"+a:"--"}function b(b){var c,d,e;return c=b,e=Math.floor(c/3600),c%=3600,d=Math.floor(c/60),c%=60,a(e)+":"+a(d)+":"+a(c)}return function(a){return a=a||"",0===a.length?"--:--:--":b(parseInt(a))}},ngZeroTile=function(){return function(a,b){var c,d,e=110,f=12,g=a.board.row*(e+f),h=a.board.col*(e+f);b.css({"margin-top":g+"px","margin-left":h+"px"}),a.$on("init",function(c){c.stopPropagation(),g=a.board.row*(e+f),h=a.board.col*(e+f),b.css({"margin-top":g+"px","margin-left":h+"px"})}),a.$on("move",function(i,j){i.stopPropagation(),c=a.board.row*(e+f)-g,d=a.board.col*(e+f)-h,g=a.board.row*(e+f),h=a.board.col*(e+f),console.log(j.duration),b.animate({"margin-top":g+"px","margin-left":h+"px"},j.duration,"linear")})}},myApp=angular.module("myApp",["angular-gestures","ui.bootstrap"]);myApp.controller("myController",myController),myApp.filter("duration",durationFilter),myApp.directive("ngZeroTile",["$interval",ngZeroTile]);